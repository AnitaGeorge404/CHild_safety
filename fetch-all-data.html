<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CHild_safety Database Viewer</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 32px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }
    .status {
      display: inline-block;
      padding: 8px 16px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 20px;
    }
    .status.connected { background: #10b981; color: white; }
    .status.error { background: #ef4444; color: white; }
    .status.loading { background: #f59e0b; color: white; }
    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
    }
    button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    button.primary { background: #3b82f6; color: white; }
    button.secondary { background: #6b7280; color: white; }
    button.success { background: #10b981; color: white; }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    .card {
      background: #f9fafb;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 20px;
    }
    .card h2 {
      color: #1f2937;
      margin-bottom: 15px;
      font-size: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .count {
      display: inline-block;
      background: #3b82f6;
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 700;
    }
    .record {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
    }
    .record-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #e5e7eb;
    }
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .badge.fall { background: #fee2e2; color: #991b1b; }
    .badge.violent { background: #fef3c7; color: #92400e; }
    .badge.abnormal { background: #dbeafe; color: #1e40af; }
    .details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
      font-size: 13px;
    }
    .detail-item {
      display: flex;
      flex-direction: column;
    }
    .detail-label {
      color: #6b7280;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }
    .detail-value {
      color: #1f2937;
      font-weight: 600;
    }
    .location {
      background: #ecfdf5;
      border: 2px solid #10b981;
      border-radius: 8px;
      padding: 12px;
      margin-top: 10px;
    }
    .location-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      font-weight: 700;
      color: #065f46;
    }
    .map-link {
      display: inline-block;
      margin-top: 8px;
      padding: 6px 12px;
      background: #10b981;
      color: white;
      text-decoration: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
    }
    .map-link:hover { background: #059669; }
    .empty {
      text-align: center;
      padding: 40px;
      color: #9ca3af;
      font-style: italic;
    }
    pre {
      background: #1f2937;
      color: #10b981;
      padding: 15px;
      border-radius: 8px;
      font-size: 12px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîí CHild_safety Database Viewer</h1>
    <p class="subtitle">Real-time view of all data in CHild_safety Supabase database</p>
    
    <div id="status" class="status loading">‚è≥ Connecting to Supabase...</div>
    
    <div class="controls">
      <button class="primary" onclick="fetchAllData()">üîÑ Refresh Data</button>
      <button class="success" onclick="insertTestAlert()">‚ûï Insert Test Alert</button>
      <button class="secondary" onclick="clearAll()">üóëÔ∏è Clear All Data</button>
    </div>

    <div class="grid">
      <div class="card">
        <h2>‚ö†Ô∏è ALERTS <span id="alertCount" class="count">0</span></h2>
        <div id="alertsContainer"></div>
      </div>

      <div class="card">
        <h2>üìä DETECTIONS <span id="detectionCount" class="count">0</span></h2>
        <div id="detectionsContainer"></div>
      </div>
    </div>

    <div class="card">
      <h2>üíª Debug Console</h2>
      <pre id="console">Waiting for data...</pre>
    </div>
  </div>

  <script>
    const { createClient } = supabase;
    
    const supabaseClient = createClient(
      'https://rlvgephkagtejlogudqo.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJsdmdlcGhrYWd0ZWpsb2d1ZHFvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MzI0MzgsImV4cCI6MjA4NDIwODQzOH0.mZs84-tEUKc73j0HqCXwaD1FDB-8C6fvvnPRuhPy2oM'
    );

    let logOutput = [];
    function log(msg) {
      logOutput.push(`[${new Date().toLocaleTimeString()}] ${msg}`);
      document.getElementById('console').textContent = logOutput.join('\n');
      console.log(msg);
    }

    function getBadgeClass(type) {
      if (type === 'fall') return 'fall';
      if (type === 'violent_movement') return 'violent';
      return 'abnormal';
    }

    async function fetchAllData() {
      try {
        log('üîç Fetching all data from CHild_safety database...');
        document.getElementById('status').className = 'status loading';
        document.getElementById('status').textContent = '‚è≥ Loading...';

        // Fetch alerts
        const { data: alerts, error: alertsError } = await supabaseClient
          .from('alerts')
          .select('*')
          .order('created_at', { ascending: false });

        if (alertsError) throw alertsError;

        // Fetch detections
        const { data: detections, error: detectionsError } = await supabaseClient
          .from('detections')
          .select('*')
          .order('created_at', { ascending: false });

        if (detectionsError) throw detectionsError;

        log(`‚úÖ Found ${alerts.length} alerts and ${detections.length} detections`);
        
        // Update status
        document.getElementById('status').className = 'status connected';
        document.getElementById('status').textContent = '‚úÖ Connected to CHild_safety Supabase';

        // Update counts
        document.getElementById('alertCount').textContent = alerts.length;
        document.getElementById('detectionCount').textContent = detections.length;

        // Display alerts
        const alertsContainer = document.getElementById('alertsContainer');
        if (alerts.length === 0) {
          alertsContainer.innerHTML = '<div class="empty">No alerts found. Click "Insert Test Alert" to add data.</div>';
        } else {
          alertsContainer.innerHTML = alerts.map(alert => `
            <div class="record">
              <div class="record-header">
                <span class="badge ${getBadgeClass(alert.type)}">${alert.type.replace('_', ' ')}</span>
                <span style="font-size: 12px; color: #6b7280;">${new Date(alert.created_at).toLocaleString()}</span>
              </div>
              <div class="details">
                <div class="detail-item">
                  <span class="detail-label">Confidence</span>
                  <span class="detail-value">${(alert.confidence * 100).toFixed(1)}%</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Device</span>
                  <span class="detail-value">${alert.device_info || 'Unknown'}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Alert ID</span>
                  <span class="detail-value">${alert.id.slice(0, 8)}...</span>
                </div>
              </div>
              ${alert.latitude && alert.longitude ? `
                <div class="location">
                  <div class="location-header">
                    üìç Location Captured
                  </div>
                  <div style="font-size: 13px; margin-bottom: 8px;">
                    <strong>Coordinates:</strong> ${alert.latitude.toFixed(4)}, ${alert.longitude.toFixed(4)}
                  </div>
                  <div style="font-size: 12px; color: #065f46; margin-bottom: 8px;">
                    ${alert.address || 'No address available'}
                  </div>
                  <a href="https://www.google.com/maps?q=${alert.latitude},${alert.longitude}" 
                     target="_blank" class="map-link">
                    üó∫Ô∏è View on Google Maps
                  </a>
                </div>
              ` : '<div style="font-size: 12px; color: #9ca3af; margin-top: 10px;">‚ö†Ô∏è No location data</div>'}
            </div>
          `).join('');
        }

        // Display detections
        const detectionsContainer = document.getElementById('detectionsContainer');
        if (detections.length === 0) {
          detectionsContainer.innerHTML = '<div class="empty">No detections found.</div>';
        } else {
          detectionsContainer.innerHTML = detections.map(detection => `
            <div class="record">
              <div class="record-header">
                <span class="badge ${getBadgeClass(detection.type)}">${detection.type.replace('_', ' ')}</span>
                <span style="font-size: 12px; color: #6b7280;">${new Date(detection.created_at).toLocaleString()}</span>
              </div>
              <div class="details">
                <div class="detail-item">
                  <span class="detail-label">Confidence</span>
                  <span class="detail-value">${(detection.confidence * 100).toFixed(1)}%</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Device</span>
                  <span class="detail-value">${detection.device_info || 'Unknown'}</span>
                </div>
              </div>
            </div>
          `).join('');
        }

      } catch (error) {
        log(`‚ùå Error: ${error.message}`);
        document.getElementById('status').className = 'status error';
        document.getElementById('status').textContent = `‚ùå Error: ${error.message}`;
      }
    }

    async function insertTestAlert() {
      try {
        log('‚ûï Inserting test alert with location...');
        
        const testAlert = {
          type: 'violent_movement',
          confidence: 0.95,
          timestamp: Date.now(),
          alert_triggered_at: new Date().toISOString(),
          device_info: 'Test Device - ' + new Date().toLocaleTimeString(),
          latitude: 10.0889 + (Math.random() - 0.5) * 0.01,
          longitude: 76.6400 + (Math.random() - 0.5) * 0.01,
          address: 'Test Location - MACE Area',
          location_accuracy: 15.5
        };

        const { data, error } = await supabaseClient
          .from('alerts')
          .insert([testAlert])
          .select();

        if (error) throw error;

        log(`‚úÖ Test alert inserted successfully!`);
        alert('‚úÖ Test alert inserted! Refreshing data...');
        await fetchAllData();
      } catch (error) {
        log(`‚ùå Error inserting test alert: ${error.message}`);
        alert(`‚ùå Error: ${error.message}`);
      }
    }

    async function clearAll() {
      if (!confirm('‚ö†Ô∏è Are you sure you want to delete ALL data from the database?')) {
        return;
      }

      try {
        log('üóëÔ∏è Clearing all data...');
        
        // Delete all alerts
        const { error: alertsError } = await supabaseClient
          .from('alerts')
          .delete()
          .neq('id', '00000000-0000-0000-0000-000000000000');

        if (alertsError) throw alertsError;

        // Delete all detections
        const { error: detectionsError } = await supabaseClient
          .from('detections')
          .delete()
          .neq('id', '00000000-0000-0000-0000-000000000000');

        if (detectionsError) throw detectionsError;

        log('‚úÖ All data cleared!');
        alert('‚úÖ All data cleared!');
        await fetchAllData();
      } catch (error) {
        log(`‚ùå Error clearing data: ${error.message}`);
        alert(`‚ùå Error: ${error.message}`);
      }
    }

    // Initial load
    fetchAllData();

    // Auto-refresh every 5 seconds
    setInterval(fetchAllData, 5000);
  </script>
</body>
</html>
